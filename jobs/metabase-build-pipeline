#!/usr/bin/env groovy

node {

    def git_tag = "v0.28.0"
    def git_repo = "https://github.com/metabase/metabase.git"

    stage("Pull repository") {
        checkout([$class: 'GitSCM', branches: [[name: 'tags/' + git_tag ]],
                                    browser: [$class: 'GithubWeb', repoUrl: 'https://github.com/metabase/metabase'],
                                    userRemoteConfigs:
                                    [[url: git_repo]]
                ])

    }

    stage("Update version") {
        sh "./bin/build version"
    }

    stage("Build frontend") {
        docker.image("docker.io/node:8-alpine").withRun{
            sh "./bin/build frontend-deps frontend"
        }
    }

    stage("Build uberjar") {
        docker.image("docker.io/clojure:lein-alpine").withRun{
            sh "./bin/build uberjar"
        }
    }

    stage("Cleanup"){
        deleteDir()
    }
}
