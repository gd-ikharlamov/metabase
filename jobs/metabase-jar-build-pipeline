#!/usr/bin/env groovy

node {

    def metabase_version = "0.28.1"
    def git_repo = "https://github.com/metabase/metabase.git"
    def registry = "registry.pmo.aws.griddynamics.net"

    stage("Pull repository") {
        checkout([$class: 'GitSCM', branches: [[name: 'tags/v' + metabase_version ]],
                                    browser: [$class: 'GithubWeb', repoUrl: 'https://github.com/metabase/metabase'],
                                    userRemoteConfigs: [[url: git_repo]]
        ])
    }

    stage("Build metabase") {
        docker.image("${registry}/metabase-buildenv:latest").inside("-e HOME=${env.WORKDIR}") {
            sh 'export NODE_OPTIONS=--max_old_space_size=128 && \
                node -v && \
                ./bin/build'
        }
    }

    stage("Archive artifact") {
        archiveArtifacts artifacts: 'target/uberjar/metabase.jar',
                         onlyIfSuccessful: true
    }

    stage("Deploy docker image") {
        build job: 'docker-build',
              parameters: [
                           string(name: 'metabase_version', value: "${metabase_version}")
                          ]
    }

    stage("Cleanup"){
        deleteDir()
    }
}
