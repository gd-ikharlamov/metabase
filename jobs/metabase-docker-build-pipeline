#!/usr/bin/env groovy

node {

    def git_repo = "https://github.com/gd-ikharlamov/metabase"
    def registry = "registry.pmo.aws.griddynamics.net"
    def metabase_version = ""

    stage("Pull repository") {
        checkout([$class: 'GitSCM', branches: [[name: 'master' ]],
                                    browser: [$class: 'GithubWeb', repoUrl: 'https://github.com/gd-ikharlamov/metabase'],
                                    userRemoteConfigs: [[url: git_repo]]
        ])
    }

    stage('Copy metabase.jar') {
        copyArtifacts filter: 'metabase.jar',
                      fingerprintArtifacts: true,
                      projectName: 'metabase/jar-build',
                      target: 'containers/metabase/files/opt'
    }

    stage('Build docker image') {
        app = docker.build("${registry}/metabase", "containers/metabase/")
    }

    stage('Push image') {
        withDockerRegistry([url: "${registry}"]) {
            app.push("${metabase_version}")
            app.push("latest")
        }
    }
}
